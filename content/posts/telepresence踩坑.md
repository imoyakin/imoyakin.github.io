---
title: "Telepresence踩坑"
date: 2022-12-28T11:21:05+08:00
draft: false
---

# telepresence 踩坑

## telepresence 用法

> k8s pod IP 由 CNI 分配, 通信是走 overlay 网络, 容器之间的通信都是基于cluser IP.[<sup>[1]](#refer-anchor-1)

k8s的软件调试出了名的难搞,如果遇到日志设计不合理/不熟悉的代码,能打断点总是.没错,这就是我使用telepresence点初衷-- telepresence可以让本机接入k8s的overlay网络的同时,通过sidecar的方式拦截具体pod的流量转发到执行intercept的本地环境.

## troublneshooting
1. 无法建立和k8s内容器的链接/dns解析容器内部域名·失败  
调试环境建立起来后,简单测试: `curl -ik https://kubernetes.default`, 返回一串json,表明成功解析了k8s的域名.
调试程序时,我执行curl去访问`etcd.dev.svc.cluster.local`这样自己搭建的资源时,却报错无法解析相应的dns,同时发现nslookup也无法解析.

在我的使用环境archlinux下,telepresence想要将k8s上服务的流量拦截到用户本机上,需要建立一个名为`tel0`的tun设备,这样本机就可以请求到k8s中服务的ip.但是光能链接ip不行,还需要让k8s内部的dns服务提供给用户的开发机,只有这样用户调试的软件才能和k8s集群内其他服务互通有无.

但是这里遇到的一个问题: /etc/resolv.conf不归属用户.我甚至使用sudo的权限删除了这个文件,但是还是被软件立马创建了出来.在一些文章中,这种情况被描述为一些服务把持着这个文件,阻止用户删除,甚至出现了数款服务互相争夺dns控制权互相覆写乃至于出现了dns中断的情况.
我的情况稍微简单,`cat /etc/resolv.conf`,观察到这样的内容:  
```
# Generated by dhcpcd from ens33.dhcp
# /etc/resolv.conf.head can replace this line
domain AirDream
nameserver 114.114.114.114
# /etc/resolv.conf.tail can replace this line
```
文件描述其被dhcpcd生成,查询[资料](https://wiki.archlinux.org/title/Dhcpcd#/etc/resolv.conf),可以通过修改配置解除自动的文件生成. 即: 在`/etc/dhcpcd.conf`中添加`nohook resolv.conf`配置.
如果文件没有描述其被哪个文件生成,那就要辛辛苦苦的去排查了.
然后执行 ` ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf`,让systemd-resolved生效.
如果 `/run/systemd/resolve/stub-resolv.conf` 之前被dhcp服务修改了,重启systemd—resolved就行.

随后才是安装telepresence所依赖的`systemd-resolved`软件,这样curl就可以正常访问资源了.  
最后推断是因为telepresence是通过system-resolve来让本地能解析k8s中服务的域名,其不工作的的状态下,执行 `curl -ik https://kubernetes.default`能返回结果,不是访问k8s服务的在telepresence里配置的外网ip,就是写死了ip `10.96.0.1`....

2. 乱搞了环境,删了telepresence,想全新安装
通用指令 `telepresence uninstall --everything`

telepresence被玩坏了:
```bash
# k8s 环境的机器
kubectl delete namespace ambassador # telepresence 安装时的namespace
# telepresence的机器
sudo rm -rf ./config/telepresence
sudo rm -rf ./cache/telepresence
```

3. leave 不灵,还想用这个k8s环境
具体做法就是取消sidecar的注入,去修改被注入环境的deployment.   
干掉其中的如下注解:
```
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
```
你这个pod就不会发呆睡觉了.

## 参考:

<div id="refer-anchor-1"></div>

1. [Telepresence实践及踩坑记](https://ttys3.dev/post/k8s-telepresence-in-action/)